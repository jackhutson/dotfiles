---
phase: 02-secrets
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - home/.chezmoi.toml.tmpl
  - home/private_dot_ssh/config.tmpl
  - home/private_dot_gitconfig.tmpl
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Templates can retrieve secrets via onepasswordRead function"
    - "SSH connections use 1Password SSH agent (no local key files)"
    - "Git commits are signed via 1Password"
  artifacts:
    - path: "home/.chezmoi.toml.tmpl"
      provides: "1Password integration config"
      contains: "[onepassword]"
    - path: "home/private_dot_ssh/config.tmpl"
      provides: "SSH config using 1Password agent"
      contains: "IdentityAgent"
    - path: "home/private_dot_gitconfig.tmpl"
      provides: "Git config with signing"
      contains: "gpgsign = true"
  key_links:
    - from: "home/private_dot_gitconfig.tmpl"
      to: "1Password vault"
      via: "onepasswordRead for signing key"
      pattern: "onepasswordRead.*public key"
    - from: "home/private_dot_ssh/config.tmpl"
      to: "~/.1password/agent.sock"
      via: "IdentityAgent directive"
      pattern: "IdentityAgent.*1password/agent.sock"
---

<objective>
Create SSH and Git configuration templates that integrate with 1Password for secure key management.

Purpose: All SSH connections and Git commit signing should use 1Password-managed keys with no local key files required.
Output: Three templated config files - updated chezmoi config, SSH config, and Git config.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-secrets/02-RESEARCH.md
@.planning/phases/02-secrets/02-CONTEXT.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

# Existing config to extend
@home/.chezmoi.toml.tmpl
@home/.chezmoidata.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add 1Password configuration to chezmoi</name>
  <files>home/.chezmoi.toml.tmpl</files>
  <action>
Update the existing `.chezmoi.toml.tmpl` to add 1Password integration:

1. Add `[onepassword]` section with `prompt = true` (enables interactive auth prompts)
2. Keep all existing content (device type prompt, email derivation, data section, secrets error config)
3. Place the `[onepassword]` section after the `[data]` section and before `[add]`

Reference the verified pattern from RESEARCH.md:
```toml
[onepassword]
    prompt = true
```

This enables chezmoi to prompt for 1Password authentication when templates use `onepasswordRead`.
  </action>
  <verify>
Run `chezmoi cat-config` and confirm `[onepassword]` section exists with `prompt = true`.
Alternatively, inspect the generated config at `~/.config/chezmoi/chezmoi.toml`.
  </verify>
  <done>
`.chezmoi.toml.tmpl` contains `[onepassword]` section with `prompt = true`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SSH config with 1Password agent</name>
  <files>home/private_dot_ssh/config.tmpl</files>
  <action>
Create `home/private_dot_ssh/config.tmpl` with SSH config that uses 1Password SSH agent:

1. Create directory `home/private_dot_ssh/` (the `private_` prefix sets 0700 permissions on the directory)
2. Create `config.tmpl` with the following content:

```go-template
{{/* SSH configuration - uses 1Password SSH agent */}}

# Global settings - all hosts use 1Password agent
Host *
    # Use 1Password SSH agent for all connections
    IdentityAgent "~/.1password/agent.sock"
    # Only use identities from agent, don't try default files
    IdentitiesOnly yes
    # Add keys to agent when used
    AddKeysToAgent yes

# GitHub
Host github.com
    HostName github.com
    User git
```

Key points per CONTEXT.md decisions:
- Uses default socket location `~/.1password/agent.sock` (works on both macOS and Linux)
- No fallback to system agent (IdentitiesOnly yes)
- Same config on all devices (no conditionals needed)
- GitHub as primary host, structure allows easy addition of other hosts

Note: The `private_` prefix ensures the directory and file have restricted permissions (0700 for dir, 0600 for files).
  </action>
  <verify>
Run `chezmoi diff` and confirm the SSH config will be created at `~/.ssh/config` with correct content.
Run `chezmoi managed | grep ssh` to confirm the file is tracked.
  </verify>
  <done>
`home/private_dot_ssh/config.tmpl` exists with IdentityAgent pointing to `~/.1password/agent.sock` and IdentitiesOnly set.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Git config with 1Password signing</name>
  <files>home/private_dot_gitconfig.tmpl</files>
  <action>
Create `home/private_dot_gitconfig.tmpl` with Git config including 1Password commit signing:

```go-template
{{/* .gitconfig - Git configuration with 1Password signing */}}

[user]
    name = {{ .git.name | quote }}
    email = {{ .email | quote }}
    # SSH public key for signing - retrieved from 1Password
    # NOTE: Update the op:// path to match your actual 1Password item
    signingkey = {{ onepasswordRead "op://Personal/GitHub SSH Key/public key" | quote }}

[init]
    defaultBranch = {{ .git.defaultBranch | quote }}

[commit]
    gpgsign = true

[tag]
    gpgsign = true

[gpg]
    format = ssh

[gpg "ssh"]
{{ if eq .chezmoi.os "darwin" -}}
    program = "/Applications/1Password.app/Contents/MacOS/op-ssh-sign"
{{ else -}}
    program = "/opt/1Password/op-ssh-sign"
{{ end -}}

[core]
    editor = {{ .editor.default | quote }}

[pull]
    rebase = false

[push]
    autoSetupRemote = true

[rerere]
    enabled = true

[fetch]
    prune = true
```

Key points per CONTEXT.md and RESEARCH.md:
- Signs all commits globally (`gpgsign = true`)
- Uses SSH key format (`gpg.format = ssh`)
- Platform-specific path to `op-ssh-sign` binary (macOS vs Linux)
- Retrieves signing key via `onepasswordRead` from 1Password
- Uses `.git.name`, `.git.defaultBranch`, `.editor.default` from `.chezmoidata.toml`
- Uses `.email` which is derived from device type in `.chezmoi.toml.tmpl`

Note: The `private_` prefix ensures the file is not shown in diff by default and has restricted permissions.

IMPORTANT: The `op://Personal/GitHub SSH Key/public key` path assumes a 1Password item named "GitHub SSH Key" in the "Personal" vault with a "public key" field. This may need adjustment based on the user's actual 1Password structure. The verification script in Plan 02 will help identify if this path is incorrect.
  </action>
  <verify>
Run `chezmoi diff` and confirm the gitconfig will be created at `~/.gitconfig` with:
- `gpgsign = true` in commit section
- `format = ssh` in gpg section
- Platform-appropriate path to op-ssh-sign
Run `chezmoi execute-template '{{ onepasswordRead "op://Personal/GitHub SSH Key/public key" }}'` to verify the 1Password path works (will prompt for auth).
  </verify>
  <done>
`home/private_dot_gitconfig.tmpl` exists with signing configuration using `onepasswordRead` for the key and platform-conditional `op-ssh-sign` path.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. All three files exist in the home/ directory
2. `chezmoi diff` shows the planned changes to ~/.ssh/config and ~/.gitconfig
3. Running `chezmoi apply --dry-run` completes without errors (may prompt for 1Password)
</verification>

<success_criteria>
- `.chezmoi.toml.tmpl` includes `[onepassword]` section with `prompt = true`
- `private_dot_ssh/config.tmpl` exists with `IdentityAgent ~/.1password/agent.sock`
- `private_dot_gitconfig.tmpl` exists with `gpgsign = true`, `format = ssh`, and `onepasswordRead` for signing key
- Platform conditional correctly selects op-ssh-sign path
</success_criteria>

<output>
After completion, create `.planning/phases/02-secrets/02-01-SUMMARY.md`
</output>
