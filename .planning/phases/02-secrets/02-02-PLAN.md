---
phase: 02-secrets
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - home/.chezmoiscripts/run_after_10-verify-secrets.sh.tmpl
autonomous: false
user_setup: []

must_haves:
  truths:
    - "Running chezmoi diff shows no secrets in plain text (uses private_ prefix)"
    - "Verification script confirms SSH agent is working"
    - "Verification script confirms GitHub SSH auth works"
    - "Verification script confirms Git signing is configured"
  artifacts:
    - path: "home/.chezmoiscripts/run_after_10-verify-secrets.sh.tmpl"
      provides: "Automated verification of 1Password integration"
      contains: "ssh-add -l"
  key_links:
    - from: "run_after script"
      to: "~/.1password/agent.sock"
      via: "socket existence check"
      pattern: "-S.*1password/agent.sock"
    - from: "run_after script"
      to: "git config"
      via: "gpg.format check"
      pattern: 'git config.*gpg.format'
---

<objective>
Create verification script and confirm 1Password integration works end-to-end.

Purpose: Ensure SSH agent, SSH authentication, and Git signing are all working correctly after chezmoi apply.
Output: A run_after verification script and confirmed working configuration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-secrets/02-RESEARCH.md
@.planning/phases/02-secrets/02-CONTEXT.md
@.planning/phases/02-secrets/02-01-SUMMARY.md

# Configs created in Plan 01
@home/private_dot_ssh/config.tmpl
@home/private_dot_gitconfig.tmpl
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create verification script</name>
  <files>home/.chezmoiscripts/run_after_10-verify-secrets.sh.tmpl</files>
  <action>
Create `home/.chezmoiscripts/run_after_10-verify-secrets.sh.tmpl`:

1. Create directory `home/.chezmoiscripts/` if it doesn't exist
2. Create the verification script with these checks (per CONTEXT.md decisions):

```bash
#!/bin/bash
{{/* Verification script for 1Password integration */}}
{{/* Runs after chezmoi apply to ensure configuration is working */}}

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

errors=0
warnings=0

echo "Verifying 1Password integration..."
echo ""

# Check 1: 1Password SSH agent socket exists
echo -n "  SSH agent socket... "
if [ -S "$HOME/.1password/agent.sock" ]; then
    echo -e "${GREEN}OK${NC}"
else
    echo -e "${RED}FAILED${NC}"
    echo "    Socket not found at ~/.1password/agent.sock"
    echo "    Enable SSH agent: 1Password > Settings > Developer > SSH Agent"
    ((errors++))
fi

# Check 2: SSH agent is responding and has keys
echo -n "  SSH agent keys... "
if SSH_AUTH_SOCK="$HOME/.1password/agent.sock" ssh-add -l >/dev/null 2>&1; then
    key_count=$(SSH_AUTH_SOCK="$HOME/.1password/agent.sock" ssh-add -l 2>/dev/null | wc -l | tr -d ' ')
    echo -e "${GREEN}OK${NC} ($key_count key(s))"
else
    echo -e "${RED}FAILED${NC}"
    echo "    No keys available from SSH agent"
    echo "    Unlock 1Password and ensure SSH keys have 'Use for SSH' enabled"
    ((errors++))
fi

# Check 3: GitHub SSH authentication works
echo -n "  GitHub SSH auth... "
github_result=$(ssh -o BatchMode=yes -o ConnectTimeout=5 -T git@github.com 2>&1)
if echo "$github_result" | grep -q "successfully authenticated"; then
    echo -e "${GREEN}OK${NC}"
elif echo "$github_result" | grep -q "Permission denied"; then
    echo -e "${RED}FAILED${NC}"
    echo "    GitHub SSH authentication failed"
    echo "    Add your public key to GitHub: https://github.com/settings/keys"
    ((errors++))
else
    echo -e "${YELLOW}UNKNOWN${NC}"
    echo "    Could not determine GitHub auth status"
    echo "    Response: $github_result"
    ((warnings++))
fi

# Check 4: Git signing format configured
echo -n "  Git signing format... "
gpg_format=$(git config --global gpg.format 2>/dev/null)
if [ "$gpg_format" = "ssh" ]; then
    echo -e "${GREEN}OK${NC}"
else
    echo -e "${RED}FAILED${NC}"
    echo "    gpg.format should be 'ssh', got '$gpg_format'"
    ((errors++))
fi

# Check 5: Git commit signing enabled
echo -n "  Git commit signing... "
gpg_sign=$(git config --global commit.gpgsign 2>/dev/null)
if [ "$gpg_sign" = "true" ]; then
    echo -e "${GREEN}OK${NC}"
else
    echo -e "${RED}FAILED${NC}"
    echo "    commit.gpgsign should be 'true', got '$gpg_sign'"
    ((errors++))
fi

# Check 6: op-ssh-sign binary exists
echo -n "  op-ssh-sign binary... "
{{ if eq .chezmoi.os "darwin" -}}
op_ssh_sign="/Applications/1Password.app/Contents/MacOS/op-ssh-sign"
{{ else -}}
op_ssh_sign="/opt/1Password/op-ssh-sign"
{{ end -}}
if [ -x "$op_ssh_sign" ]; then
    echo -e "${GREEN}OK${NC}"
else
    echo -e "${RED}FAILED${NC}"
    echo "    Binary not found or not executable at $op_ssh_sign"
    echo "    Install 1Password Desktop app"
    ((errors++))
fi

# Summary
echo ""
if [ $errors -eq 0 ] && [ $warnings -eq 0 ]; then
    echo -e "${GREEN}All 1Password integration checks passed!${NC}"
    exit 0
elif [ $errors -eq 0 ]; then
    echo -e "${YELLOW}$warnings warning(s), but no errors${NC}"
    exit 0
else
    echo -e "${RED}$errors error(s), $warnings warning(s)${NC}"
    echo "Please fix the issues above and run 'chezmoi apply' again"
    exit 1
fi
```

Key points:
- Uses `run_after_` prefix so it runs after files are applied
- Uses `10-` in filename for ordering (allows future scripts before/after)
- Checks all items per CONTEXT.md: socket exists, agent has keys, GitHub auth, git signing config
- Clear error messages with remediation steps
- Exit 1 on failures so chezmoi reports the error
- Uses BatchMode for SSH check to avoid hanging on prompts
  </action>
  <verify>
Run `chezmoi managed | grep verify` to confirm the script is tracked.
Run `chezmoi cat home/.chezmoiscripts/run_after_10-verify-secrets.sh.tmpl` to confirm content.
  </verify>
  <done>
Verification script exists at `home/.chezmoiscripts/run_after_10-verify-secrets.sh.tmpl` with all required checks.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete 1Password integration:
- SSH config using 1Password agent
- Git config with 1Password signing
- Verification script that checks everything
  </what-built>
  <how-to-verify>
1. Ensure 1Password is running and unlocked
2. Ensure 1Password SSH agent is enabled (Settings > Developer > SSH Agent)
3. Run `chezmoi apply -v` (will apply configs and run verification)
4. Observe verification script output - all checks should pass:
   - SSH agent socket: OK
   - SSH agent keys: OK (shows key count)
   - GitHub SSH auth: OK
   - Git signing format: OK
   - Git commit signing: OK
   - op-ssh-sign binary: OK

If any checks fail:
- SSH agent socket: Enable SSH agent in 1Password settings
- SSH agent keys: Unlock 1Password, ensure keys have "Use for SSH" enabled
- GitHub SSH auth: Add public key to https://github.com/settings/keys
- Git signing/format: Check the gitconfig was applied correctly
- op-ssh-sign: Install 1Password Desktop app

If the 1Password item path is wrong (error during apply about onepasswordRead):
- Run `op item list --categories "SSH Key"` to find your SSH key item
- Update the `op://` path in `home/private_dot_gitconfig.tmpl`
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
After checkpoint approval:

1. `chezmoi apply` completes successfully
2. Verification script reports all checks passed
3. `ssh -T git@github.com` returns "successfully authenticated"
4. `git config --global commit.gpgsign` returns "true"
5. `git config --global gpg.format` returns "ssh"
</verification>

<success_criteria>
- Verification script runs after `chezmoi apply`
- All 6 verification checks pass
- SSH connections use 1Password agent (no local key files)
- Git is configured for SSH-based commit signing via 1Password
- User has confirmed working configuration
</success_criteria>

<output>
After completion, create `.planning/phases/02-secrets/02-02-SUMMARY.md`
</output>
