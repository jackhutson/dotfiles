# Phase 4: App Ecosystem - Research

**Researched:** 2026-01-18
**Domain:** Application configs, CLI tools, and package management with chezmoi
**Confidence:** HIGH

## Summary

Phase 4 migrates application configurations (nvim/LazyVim, ghostty, htop, gh CLI, kanata) and CLI tool settings (bat, eza, fd, fzf, jq, lazygit, ripgrep, zoxide) into chezmoi management, plus establishes declarative package installation via Brewfile (macOS) and pacman/yay scripts (Arch Linux).

The user already has most configs in place at standard XDG locations (`~/.config/`). Key challenges include:
1. **nvim/LazyVim**: Existing git-managed config needs chezmoi integration without breaking lazy.nvim bootstrap
2. **lazygit path difference**: macOS default is `~/Library/Application Support/lazygit/`, Linux is `~/.config/lazygit/`
3. **CLI tool configs**: Most use environment variables (fzf, zoxide, ripgrep, eza, jq), not config files
4. **Package management**: Brewfile with hash-based run_onchange for macOS, pacman script for Arch

**Primary recommendation:** Copy nvim config directly into chezmoi source (not as external), use `.chezmoiignore` for lazygit path differences, configure CLI tools via zshrc environment variables, and use `.chezmoidata/packages.yaml` with templated run_onchange scripts for declarative package installation.

## Standard Stack

### Application Configs

| Application | Config Location (macOS) | Config Location (Linux) | Management Strategy |
|-------------|------------------------|-------------------------|---------------------|
| nvim/LazyVim | `~/.config/nvim/` | `~/.config/nvim/` | Direct copy to `dot_config/nvim/` |
| ghostty | `~/.config/ghostty/config` | `~/.config/ghostty/config` | Static file, same path both OS |
| htop | `~/.config/htop/htoprc` | `~/.config/htop/htoprc` | Static file (auto-regenerated by htop) |
| gh CLI | `~/.config/gh/config.yml` | `~/.config/gh/config.yml` | Static file, same path both OS |
| kanata | `~/.config/kanata/kanata.kbd` | `~/.config/kanata/kanata.kbd` | macOS-only via `.chezmoiignore` |

### CLI Tool Configs

| Tool | Config Type | Config Location/Variable | Notes |
|------|-------------|--------------------------|-------|
| bat | XDG config file | `~/.config/bat/config` | Same path on both OS |
| eza | Environment + theme | `EZA_ICONS_AUTO`, `~/.config/eza/theme.yml` | Mostly env vars |
| fd | Global ignore file | `~/.config/fd/ignore` | Same path on both OS |
| fzf | Environment vars | `FZF_DEFAULT_OPTS`, `FZF_DEFAULT_COMMAND` | Set in zshrc |
| jq | Environment var | `JQ_COLORS` | Set in zshrc |
| lazygit | XDG config file | macOS: `~/Library/Application Support/lazygit/`, Linux: `~/.config/lazygit/` | **Path differs by OS** |
| ripgrep | Environment var | `RIPGREP_CONFIG_PATH` pointing to file | Set in zshrc |
| zoxide | Environment vars | `_ZO_FZF_OPTS`, `_ZO_ECHO`, etc. | Set in zshrc |

### Package Management

| OS | Tool | Config File | Management Pattern |
|----|------|-------------|-------------------|
| macOS | Homebrew Bundle | `.chezmoidata/packages.yaml` + Brewfile template | run_onchange with hash |
| Arch Linux | pacman + yay | `.chezmoidata/packages.yaml` + script template | run_onchange with hash |

## Architecture Patterns

### Recommended Source Directory Structure
```
home/
├── .chezmoidata/
│   └── packages.yaml                    # Declarative package lists
├── .chezmoiscripts/
│   ├── run_onchange_before_darwin-install-packages.sh.tmpl
│   └── run_onchange_before_linux-install-packages.sh.tmpl
├── .chezmoiignore                       # Conditional file exclusion
├── dot_config/
│   ├── nvim/                            # LazyVim config (direct copy)
│   │   ├── init.lua
│   │   ├── lazy-lock.json               # gitignored, not managed
│   │   ├── lua/
│   │   │   ├── config/
│   │   │   │   ├── autocmds.lua
│   │   │   │   ├── keymaps.lua
│   │   │   │   ├── lazy.lua
│   │   │   │   └── options.lua
│   │   │   └── plugins/
│   │   │       └── *.lua
│   │   └── stylua.toml
│   ├── ghostty/
│   │   └── config
│   ├── htop/
│   │   └── htoprc
│   ├── gh/
│   │   └── config.yml                   # hosts.yml NOT managed (secrets)
│   ├── kanata/
│   │   └── kanata.kbd
│   ├── bat/
│   │   └── config
│   ├── fd/
│   │   └── ignore
│   ├── lazygit/
│   │   └── config.yml                   # Linux path
│   └── eza/
│       └── theme.yml                    # Optional theme
├── Library/
│   └── Application Support/
│       └── lazygit/
│           └── config.yml               # macOS path
└── dot_zshrc.tmpl                       # CLI tool env vars added here
```

### Pattern 1: Direct Config Copy for nvim/LazyVim
**What:** Copy entire nvim config into chezmoi source as static files
**When to use:** For nvim with LazyVim where config is already stable
**Why not external:** LazyVim starter is meant to be forked/customized, not kept in sync
**Example structure:**
```
dot_config/nvim/
├── .gitignore                           # gitignore for lazy-lock.json
├── init.lua
├── lua/
│   ├── config/
│   │   ├── autocmds.lua
│   │   ├── keymaps.lua
│   │   ├── lazy.lua                     # Bootstrap lazy.nvim
│   │   └── options.lua
│   └── plugins/
│       └── *.lua
└── stylua.toml
```

**Important:** The `lazy.lua` file already contains the lazy.nvim bootstrap code that will clone lazy.nvim to `stdpath("data")/lazy/lazy.nvim` on first run - no chezmoi script needed.

### Pattern 2: OS-Specific Paths via .chezmoiignore
**What:** Use `.chezmoiignore` to manage configs that live in different locations per OS
**When to use:** For lazygit which uses `~/Library/Application Support/` on macOS
**Example:**
```
{{/* .chezmoiignore additions */}}

# Lazygit: macOS uses Library path, Linux uses .config
{{ if ne .chezmoi.os "darwin" }}
Library/Application Support/lazygit/
{{ end }}
{{ if ne .chezmoi.os "linux" }}
.config/lazygit/
{{ end }}
```

Both paths contain the same `config.yml` content. Chezmoi applies the correct one per OS.

### Pattern 3: CLI Tool Environment Variables in zshrc
**What:** Configure CLI tools via environment variables in `.zshrc`
**When to use:** For fzf, ripgrep, zoxide, jq, eza which use env vars
**Example:**
```zsh
# In dot_zshrc.tmpl - add after existing tool initializations

# ============================================================================
# CLI Tool Configuration
# ============================================================================

# fzf - fuzzy finder defaults
export FZF_DEFAULT_COMMAND='fd --type f --hidden --exclude .git'
export FZF_DEFAULT_OPTS='--height 40% --layout=reverse --border'
export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
export FZF_ALT_C_COMMAND='fd --type d --hidden --exclude .git'

# ripgrep - config file location
export RIPGREP_CONFIG_PATH="$HOME/.config/ripgrep/config"

# eza - enable icons by default
export EZA_ICONS_AUTO=1

# zoxide - settings (must be before zoxide init)
export _ZO_ECHO=1

# jq - custom colors (optional)
# export JQ_COLORS="1;30:0;39:0;39:0;39:0;32:1;39:1;39"
```

### Pattern 4: Declarative Package Installation with Hash Trigger
**What:** Use `.chezmoidata/packages.yaml` with run_onchange scripts
**When to use:** For Brewfile and pacman package management
**Example data file:**
```yaml
# .chezmoidata/packages.yaml
packages:
  darwin:
    taps:
      - "homebrew/bundle"
    brews:
      - bat
      - chezmoi
      - eza
      - fd
      - fzf
      - gh
      - git-delta
      - go
      - htop
      - jq
      - kanata
      - lazygit
      - neovim
      - ripgrep
      - starship
      - zoxide
      - zsh
    casks:
      - 1password-cli
      - ghostty
  linux:
    pacman:
      - bat
      - chezmoi
      - eza
      - fd
      - fzf
      - github-cli
      - git-delta
      - go
      - htop
      - jq
      - lazygit
      - neovim
      - ripgrep
      - starship
      - zoxide
      - zsh
    aur:
      - ghostty
```

**Example macOS script (`run_onchange_before_darwin-install-packages.sh.tmpl`):**
```bash
{{- if eq .chezmoi.os "darwin" -}}
#!/bin/bash
# Packages hash: {{ include ".chezmoidata/packages.yaml" | sha256sum }}

set -euo pipefail

echo "Installing Homebrew packages..."

brew bundle --no-lock --file=/dev/stdin <<EOF
{{ range .packages.darwin.taps -}}
tap {{ . | quote }}
{{ end -}}
{{ range .packages.darwin.brews -}}
brew {{ . | quote }}
{{ end -}}
{{ range .packages.darwin.casks -}}
cask {{ . | quote }}
{{ end -}}
EOF

echo "Homebrew packages installed successfully."
{{ end -}}
```

**Example Arch script (`run_onchange_before_linux-install-packages.sh.tmpl`):**
```bash
{{- if and (eq .chezmoi.os "linux") (lookPath "pacman") -}}
#!/bin/bash
# Packages hash: {{ include ".chezmoidata/packages.yaml" | sha256sum }}

set -euo pipefail

echo "Installing pacman packages..."
sudo pacman -S --needed --noconfirm \
{{ range .packages.linux.pacman -}}
  {{ . }} \
{{ end }}

{{ if lookPath "yay" -}}
echo "Installing AUR packages via yay..."
yay -S --needed --noconfirm \
{{ range .packages.linux.aur -}}
  {{ . }} \
{{ end }}
{{ end -}}

echo "Packages installed successfully."
{{ end -}}
```

### Anti-Patterns to Avoid
- **Don't use external archive for nvim:** LazyVim is meant to be customized, not synced. Direct copy is cleaner.
- **Don't manage lazy-lock.json:** This file is regenerated by lazy.nvim and will cause constant drift.
- **Don't manage gh hosts.yml:** Contains OAuth tokens - secrets should not be in dotfiles.
- **Don't template every config:** Only use `.tmpl` when content actually differs by device/OS.
- **Don't use run_once for packages:** Use run_onchange with hash - it re-runs when package list changes.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Lazy.nvim installation | chezmoi run_once script | Let lazy.lua bootstrap itself | lazy.nvim has built-in bootstrap code |
| XDG directory creation | mkdir scripts | chezmoi automatic | chezmoi creates parent directories |
| Brewfile syntax | Manual brew install calls | `brew bundle` | Idempotent, declarative |
| Package list tracking | State files | `.chezmoidata` + hash comment | chezmoi handles change detection |
| Path differences per OS | Complex template logic | `.chezmoiignore` with dual paths | Cleaner, more maintainable |

**Key insight:** Most CLI tools (fzf, ripgrep, zoxide, jq, eza) are configured via environment variables, not config files. Put these in zshrc rather than creating separate config files.

## Common Pitfalls

### Pitfall 1: Managing lazy-lock.json
**What goes wrong:** Constant diff noise in chezmoi, lock conflicts between machines
**Why it happens:** lazy-lock.json is auto-generated with exact plugin commits
**How to avoid:** Add to `.chezmoiignore` or nvim's `.gitignore`:
```
# .chezmoiignore addition
.config/nvim/lazy-lock.json
.config/nvim/.nvimlog
```
**Warning signs:** `chezmoi diff` shows lazy-lock.json changes you didn't make

### Pitfall 2: Managing gh CLI hosts.yml
**What goes wrong:** OAuth tokens committed to dotfiles repo
**Why it happens:** hosts.yml contains authentication tokens
**How to avoid:** Only manage `config.yml`, add hosts.yml to ignore:
```
# .chezmoiignore
.config/gh/hosts.yml
```
**Warning signs:** `gh auth login` fails or tokens exposed

### Pitfall 3: Lazygit Path Difference
**What goes wrong:** Config not found on one OS
**Why it happens:** macOS default is `~/Library/Application Support/lazygit/`, Linux is `~/.config/lazygit/`
**How to avoid:** Create both paths with same content, use `.chezmoiignore` for OS filtering
**Alternative:** Set `XDG_CONFIG_HOME="$HOME/.config"` on macOS to unify paths

### Pitfall 4: htop Config Overwrite
**What goes wrong:** chezmoi diff shows changes after using htop UI
**Why it happens:** htop rewrites its config file when settings change in UI
**How to avoid:** Accept this behavior or add to `.chezmoiignore`. htoprc is auto-regenerated.
**Warning signs:** Frequent htoprc diffs with minor field order changes

### Pitfall 5: ripgrep Config Not Loading
**What goes wrong:** ripgrep ignores config file
**Why it happens:** ripgrep requires `RIPGREP_CONFIG_PATH` env var - no auto-discovery
**How to avoid:** Add to zshrc before any rg usage:
```bash
export RIPGREP_CONFIG_PATH="$HOME/.config/ripgrep/config"
```
**Warning signs:** `rg --version` doesn't mention config file

### Pitfall 6: Package Script Running Every Apply
**What goes wrong:** `brew bundle` runs on every `chezmoi apply`
**Why it happens:** Not using hash comment to track content changes
**How to avoid:** Include hash in script comment:
```bash
# Packages hash: {{ include ".chezmoidata/packages.yaml" | sha256sum }}
```
**Warning signs:** Slow `chezmoi apply`, unnecessary brew/pacman operations

### Pitfall 7: Kanata on Non-macOS
**What goes wrong:** Kanata config applied on Linux VM where it's not needed
**Why it happens:** Kanata is macOS-only for this user's use case
**How to avoid:** Add to `.chezmoiignore`:
```
{{ if ne .chezmoi.os "darwin" }}
.config/kanata/
{{ end }}
```
**Warning signs:** Kanata config on Linux machines where it's not used

## Code Examples

### bat Config File
```bash
# ~/.config/bat/config
# Syntax: one option per line

--theme="Catppuccin-mocha"
--style="numbers,changes,header"
--italic-text=always
--map-syntax "*.conf:INI"
```

### fd Global Ignore File
```gitignore
# ~/.config/fd/ignore
# Uses .gitignore syntax

.git/
node_modules/
.cache/
*.pyc
__pycache__/
.DS_Store
```

### ripgrep Config File
```bash
# ~/.config/ripgrep/config (pointed to by RIPGREP_CONFIG_PATH)

--smart-case
--hidden
--glob=!.git/
--glob=!node_modules/
--glob=!*.lock
```

### lazygit Config File
```yaml
# ~/.config/lazygit/config.yml (Linux) or ~/Library/Application Support/lazygit/config.yml (macOS)
gui:
  showIcons: true
  theme:
    activeBorderColor:
      - green
      - bold
git:
  paging:
    colorArg: always
    pager: delta --dark --paging=never
os:
  editCommand: 'nvim'
```

### Complete zshrc CLI Tool Section
```zsh
# ============================================================================
# CLI Tool Configuration (add to dot_zshrc.tmpl)
# ============================================================================

# fzf - fuzzy finder
export FZF_DEFAULT_COMMAND='fd --type f --hidden --exclude .git'
export FZF_DEFAULT_OPTS='
  --height 40%
  --layout=reverse
  --border
  --info=inline
'
export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
export FZF_ALT_C_COMMAND='fd --type d --hidden --exclude .git'

# ripgrep - point to config file
export RIPGREP_CONFIG_PATH="$HOME/.config/ripgrep/config"

# eza - enable icons
export EZA_ICONS_AUTO=1

# zoxide - settings (before init)
export _ZO_ECHO=1

# Initialize tools
eval "$(zoxide init zsh)"
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Separate nvim config repo | Integrated in chezmoi source | Best practice | Single source of truth |
| Manual brew install scripts | `brew bundle` with Brewfile | Homebrew 2.0+ | Declarative, idempotent |
| run_once for packages | run_onchange with hash | chezmoi best practice | Only re-runs when list changes |
| Config files for all tools | Environment vars where appropriate | Always | Simpler, fewer files |
| `EXA_*` env vars | `EZA_*` env vars | exa -> eza fork | Use EZA prefix |

**Deprecated/outdated:**
- `exa` command - use `eza` (community fork)
- `EXA_COLORS` - still works but prefer `EZA_COLORS`
- Manual nvim plugin management - use lazy.nvim

## Open Questions

1. **nvim config as external vs direct copy**
   - What we know: User's nvim config is a customized LazyVim with 13+ plugin files
   - What's unclear: Whether to keep it as separate git repo or merge into chezmoi
   - Recommendation: Direct copy into chezmoi - simpler, config is stable

2. **Should kanata be auto-installed?**
   - What we know: User marked kanata as "manual install (opt-in reduces complexity)"
   - What's unclear: Should config be managed even if binary isn't auto-installed?
   - Recommendation: Manage config, document manual binary installation

3. **eza theme.yml vs environment variables**
   - What we know: eza supports both env vars and theme.yml file
   - What's unclear: User's preference for icon/color customization
   - Recommendation: Start with `EZA_ICONS_AUTO=1` env var, add theme.yml if needed

4. **Work-specific CLI tool configs**
   - What we know: Some tools might need different settings for work
   - What's unclear: Which tools, if any, need work/personal differentiation
   - Recommendation: Start with unified configs, add conditionals if needed

## Sources

### Primary (HIGH confidence)
- [chezmoi: Use scripts to perform actions](https://www.chezmoi.io/user-guide/use-scripts-to-perform-actions/) - run_onchange patterns
- [chezmoi: Install packages declaratively](https://www.chezmoi.io/user-guide/advanced/install-packages-declaratively/) - Package management patterns
- [chezmoi: macOS](https://www.chezmoi.io/user-guide/machines/macos/) - Homebrew integration
- [chezmoi: Manage machine-to-machine differences](https://www.chezmoi.io/user-guide/manage-machine-to-machine-differences/) - OS-specific paths
- [Ghostty Configuration](https://ghostty.org/docs/config) - Config file locations
- [lazygit Config.md](https://github.com/jesseduffield/lazygit/blob/master/docs/Config.md) - Config file paths
- [ripgrep GUIDE.md](https://github.com/BurntSushi/ripgrep/blob/master/GUIDE.md) - RIPGREP_CONFIG_PATH
- [fzf README](https://github.com/junegunn/fzf) - Environment variables
- [zoxide README](https://github.com/ajeetdsouza/zoxide) - Environment variables
- [eza README](https://github.com/eza-community/eza) - Environment variables and theme
- [fd man page](https://man.archlinux.org/man/extra/fd/fd.1.en) - Ignore file locations

### Secondary (MEDIUM confidence)
- [Lorenzo Bettini: Neovim with Chezmoi](https://www.lorenzobettini.it/2024/10/how-i-manage-neovim-configuration-with-chezmoi/) - nvim integration patterns
- [htop man page](https://man.archlinux.org/man/extra/htop/htop.1.en) - Config location
- [jq 1.8 Manual](https://jqlang.org/manual/) - JQ_COLORS variable
- [gh config manual](https://cli.github.com/manual/gh_config) - Config file locations

### Tertiary (LOW confidence)
- Various GitHub discussions on chezmoi dotfiles organization
- Community blog posts on CLI tool configuration

## Metadata

**Confidence breakdown:**
- Application configs (nvim, ghostty, htop, gh, kanata): HIGH - Official docs confirm locations
- CLI tool configs: HIGH - Official docs/READMEs confirm env vars and paths
- Package management patterns: HIGH - Official chezmoi docs with examples
- OS-specific path handling: HIGH - Multiple chezmoi sources confirm pattern

**Research date:** 2026-01-18
**Valid until:** 60 days (tools are stable, patterns unlikely to change)
