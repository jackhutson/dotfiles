---
phase: 04-app-ecosystem
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - home/.chezmoidata/packages.yaml
  - home/.chezmoiscripts/run_onchange_before_darwin-install-packages.sh.tmpl
  - home/.chezmoiscripts/run_onchange_before_linux-install-packages.sh.tmpl
autonomous: true

must_haves:
  truths:
    - "Running chezmoi apply installs packages via Brewfile on macOS"
    - "Running chezmoi apply installs packages via pacman/yay on Arch Linux"
    - "Package scripts only re-run when package list changes"
  artifacts:
    - path: "home/.chezmoidata/packages.yaml"
      provides: "Declarative package lists for both OS"
      contains: "packages:"
    - path: "home/.chezmoiscripts/run_onchange_before_darwin-install-packages.sh.tmpl"
      provides: "macOS package installation via brew bundle"
      contains: "brew bundle"
    - path: "home/.chezmoiscripts/run_onchange_before_linux-install-packages.sh.tmpl"
      provides: "Arch Linux package installation via pacman/yay"
      contains: "pacman"
  key_links:
    - from: "run_onchange scripts"
      to: "packages.yaml"
      via: "sha256sum hash in comment"
      pattern: "include.*packages\\.yaml.*sha256sum"
---

<objective>
Create declarative package management infrastructure for macOS (Homebrew) and Arch Linux (pacman/yay)

Purpose: Enable `chezmoi apply` to automatically install all required packages from a single source of truth
Output: packages.yaml data file + two OS-specific run_onchange scripts
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-app-ecosystem/04-RESEARCH.md

# Existing scripts for pattern reference
@home/.chezmoiscripts/run_after_10-verify-secrets.sh.tmpl
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create packages.yaml data file</name>
  <files>home/.chezmoidata/packages.yaml</files>
  <action>
Create `.chezmoidata/packages.yaml` with declarative package lists:

```yaml
packages:
  darwin:
    taps:
      - "homebrew/bundle"
    brews:
      - bat
      - chezmoi
      - eza
      - fd
      - fzf
      - gh
      - git-delta
      - go
      - htop
      - jq
      - lazygit
      - neovim
      - nvm
      - ripgrep
      - starship
      - zoxide
      - zsh
    casks:
      - 1password-cli
      - ghostty
  linux:
    pacman:
      - bat
      - chezmoi
      - eza
      - fd
      - fzf
      - github-cli
      - git-delta
      - go
      - htop
      - jq
      - lazygit
      - neovim
      - ripgrep
      - starship
      - zoxide
      - zsh
    aur:
      - ghostty
```

Note: kanata intentionally omitted (manual install per user decision).
Note: nvm is macOS-only (Homebrew install), on Linux use system package or manual.
  </action>
  <verify>Run `cat home/.chezmoidata/packages.yaml` and confirm YAML structure is valid</verify>
  <done>packages.yaml exists with darwin and linux sections containing appropriate packages</done>
</task>

<task type="auto">
  <name>Task 2: Create macOS package installation script</name>
  <files>home/.chezmoiscripts/run_onchange_before_darwin-install-packages.sh.tmpl</files>
  <action>
Create `run_onchange_before_darwin-install-packages.sh.tmpl`:

```bash
{{- if eq .chezmoi.os "darwin" -}}
#!/bin/bash
# Packages hash: {{ include ".chezmoidata/packages.yaml" | sha256sum }}
# This script runs when packages.yaml changes

set -euo pipefail

echo "Installing Homebrew packages..."

# Check if Homebrew is installed
if ! command -v brew &> /dev/null; then
    echo "Error: Homebrew is not installed. Install it first:"
    echo '  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"'
    exit 1
fi

brew bundle --no-lock --file=/dev/stdin <<EOF
{{ range .packages.darwin.taps -}}
tap {{ . | quote }}
{{ end -}}
{{ range .packages.darwin.brews -}}
brew {{ . | quote }}
{{ end -}}
{{ range .packages.darwin.casks -}}
cask {{ . | quote }}
{{ end -}}
EOF

echo "Homebrew packages installed successfully."
{{ end -}}
```

Key points:
- `run_onchange_before_` prefix ensures packages install BEFORE config files are applied
- Hash comment triggers re-run only when packages.yaml content changes
- `--no-lock` prevents Brewfile.lock creation
- Uses heredoc to pass Brewfile content via stdin
  </action>
  <verify>Run `chezmoi cat-config` to confirm chezmoi can parse the template, then `chezmoi execute-template < home/.chezmoiscripts/run_onchange_before_darwin-install-packages.sh.tmpl` to verify template renders correctly</verify>
  <done>macOS script exists with hash comment, brew bundle command, and proper conditionals</done>
</task>

<task type="auto">
  <name>Task 3: Create Arch Linux package installation script</name>
  <files>home/.chezmoiscripts/run_onchange_before_linux-install-packages.sh.tmpl</files>
  <action>
Create `run_onchange_before_linux-install-packages.sh.tmpl`:

```bash
{{- if and (eq .chezmoi.os "linux") (lookPath "pacman") -}}
#!/bin/bash
# Packages hash: {{ include ".chezmoidata/packages.yaml" | sha256sum }}
# This script runs when packages.yaml changes

set -euo pipefail

echo "Installing pacman packages..."

sudo pacman -S --needed --noconfirm \
{{ range .packages.linux.pacman }}  {{ . }} \
{{ end }}

{{ if lookPath "yay" -}}
echo "Installing AUR packages via yay..."
yay -S --needed --noconfirm \
{{ range .packages.linux.aur }}  {{ . }} \
{{ end }}
{{ else -}}
echo "Note: yay not found. Skipping AUR packages."
echo "Install yay to enable AUR package installation."
{{ end -}}

echo "Packages installed successfully."
{{ end -}}
```

Key points:
- Conditional on both Linux OS AND pacman availability (won't run on Debian/Ubuntu)
- `--needed` flag makes it idempotent (skips already-installed)
- yay section conditionally runs only if yay is available
- Same hash pattern as macOS script
  </action>
  <verify>Run `chezmoi execute-template < home/.chezmoiscripts/run_onchange_before_linux-install-packages.sh.tmpl` (on macOS will output nothing due to conditional, which is correct)</verify>
  <done>Linux script exists with hash comment, pacman commands, and conditional yay section</done>
</task>

</tasks>

<verification>
1. `ls -la home/.chezmoidata/` shows packages.yaml
2. `ls -la home/.chezmoiscripts/` shows both new run_onchange scripts
3. `chezmoi diff` shows the new files will be created
4. Template syntax is valid (no chezmoi template errors)
</verification>

<success_criteria>
- packages.yaml exists with darwin (taps/brews/casks) and linux (pacman/aur) sections
- macOS script generates valid Brewfile content via template
- Linux script generates valid pacman/yay commands via template
- Both scripts include sha256sum hash for change detection
- Scripts use run_onchange_before_ prefix for correct execution order
</success_criteria>

<output>
After completion, create `.planning/phases/04-app-ecosystem/04-01-SUMMARY.md`
</output>
