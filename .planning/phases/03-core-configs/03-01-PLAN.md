---
phase: 03-core-configs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - home/.chezmoiexternal.toml
  - home/dot_zshrc.tmpl
autonomous: true

must_haves:
  truths:
    - "chezmoi apply downloads oh-my-zsh and plugins automatically"
    - "New shell opens with oh-my-zsh loaded"
    - "Work device shows it() function, personal device does not"
  artifacts:
    - path: "home/.chezmoiexternal.toml"
      provides: "oh-my-zsh and plugin archive definitions"
      contains: "[.oh-my-zsh]"
    - path: "home/dot_zshrc.tmpl"
      provides: "Main shell configuration"
      contains: "{{ if .isWork }}"
  key_links:
    - from: "home/dot_zshrc.tmpl"
      to: ".oh-my-zsh"
      via: "source $ZSH/oh-my-zsh.sh"
      pattern: "source.*oh-my-zsh.sh"
---

<objective>
Create oh-my-zsh external dependency management and templated zshrc

Purpose: Enable chezmoi to automatically install oh-my-zsh with all plugins, and provide a templated zshrc that conditionally includes work-only tools (it function, playwright config).

Output: `.chezmoiexternal.toml` with oh-my-zsh archives, `dot_zshrc.tmpl` with work conditionals
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-configs/03-RESEARCH.md

# Existing chezmoi config (for reference)
@home/.chezmoi.toml.tmpl
@home/.chezmoidata.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create .chezmoiexternal.toml for oh-my-zsh and plugins</name>
  <files>home/.chezmoiexternal.toml</files>
  <action>
Create `.chezmoiexternal.toml` with archive definitions for:

1. **oh-my-zsh core** at `.oh-my-zsh`:
   - url: `https://github.com/ohmyzsh/ohmyzsh/archive/master.tar.gz`
   - type: archive, exact: true, stripComponents: 1
   - refreshPeriod: "168h" (weekly)

2. **Custom plugins** under `.oh-my-zsh/custom/plugins/`:
   - zsh-syntax-highlighting (zsh-users/zsh-syntax-highlighting)
   - zsh-autosuggestions (zsh-users/zsh-autosuggestions)
   - you-should-use (MichaelAquilina/zsh-you-should-use)
   - zsh-completions (zsh-users/zsh-completions)

Each plugin: same pattern (archive, exact, stripComponents: 1, refreshPeriod: 168h)

See research doc Pattern 1 for exact format.
  </action>
  <verify>
`cat home/.chezmoiexternal.toml` shows 5 archive definitions (oh-my-zsh + 4 plugins)
  </verify>
  <done>
.chezmoiexternal.toml exists with oh-my-zsh and all 4 custom plugins defined
  </done>
</task>

<task type="auto">
  <name>Task 2: Create dot_zshrc.tmpl with work conditionals</name>
  <files>home/dot_zshrc.tmpl</files>
  <action>
Create `dot_zshrc.tmpl` based on user's current `~/.zshrc` with these modifications:

1. **Environment section:**
   - Keep HISTFILE, ZSH_COMPDUMP, SHELL_SESSIONS_DIR, ZSH exports
   - Keep fpath setup for custom completions
   - Template EDITOR: use `{{ .editor.default }}` from chezmoidata
   - Keep LANG, LC_ALL

2. **Oh My Zsh section:**
   - Keep ZSH_THEME="robbyrussell"
   - ADD `DISABLE_AUTO_UPDATE="true"` (let chezmoi manage updates - see pitfall 1 in research)
   - Keep DISABLE_MAGIC_FUNCTIONS="true"
   - Keep full plugins list

3. **Starship section:** Keep as-is

4. **Work-only section (wrap in `{{ if .isWork }}`...`{{ end }}`):**
   - IT_BIN setup and it() function
   - AWS_PROFILE from it state file (use $HOME not /Users/jackhutson/)
   - _it completion loading
   - PLAYWRIGHT_USERNAME export

5. **Aliases section:**
   - Keep modular sourcing pattern
   - Change claude alias to use `$HOME` not hardcoded path

6. **Tool initializations:**
   - Keep NVM, FZF, zoxide, 1Password plugins
   - REMOVE CONTEXT7_API_KEY line entirely (security - should not be in dotfiles)
   - Keep Kiro integration (already conditional)
   - Keep Go bin PATH setup
   - Keep local bin PATH

7. **Completion config:** Keep zstyle and compdef lines

IMPORTANT: All paths must use `$HOME` or `{{ .chezmoi.homeDir }}`, never `/Users/jackhutson/`.
  </action>
  <verify>
- `grep "{{ if .isWork }}" home/dot_zshrc.tmpl` finds work conditional
- `grep "CONTEXT7_API_KEY" home/dot_zshrc.tmpl` returns nothing (removed)
- `grep "/Users/jackhutson" home/dot_zshrc.tmpl` returns nothing (no hardcoded paths)
- `grep "DISABLE_AUTO_UPDATE" home/dot_zshrc.tmpl` returns the line (added)
  </verify>
  <done>
dot_zshrc.tmpl exists with work conditionals, no hardcoded paths, no secrets, auto-update disabled
  </done>
</task>

</tasks>

<verification>
1. Run `chezmoi diff ~/.zshrc` - should show the templated version
2. Run `chezmoi cat-config` - confirm isWork variable exists
3. Run `chezmoi execute-template '{{ .isWork }}'` - returns true or false based on device
</verification>

<success_criteria>
- .chezmoiexternal.toml defines oh-my-zsh + 4 plugins as archives
- dot_zshrc.tmpl uses {{ if .isWork }} for work-only sections
- No hardcoded paths (/Users/jackhutson/)
- No secrets (CONTEXT7_API_KEY removed)
- DISABLE_AUTO_UPDATE="true" present
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-configs/03-01-SUMMARY.md`
</output>
