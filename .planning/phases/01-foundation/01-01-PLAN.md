---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .chezmoiroot
  - home/.chezmoi.toml.tmpl
  - home/.chezmoidata.toml
  - home/.chezmoiignore
autonomous: false

must_haves:
  truths:
    - "Running chezmoi init prompts for device type (work/personal)"
    - "Init fails if device type not selected"
    - "Config stores correct email based on device type"
    - "Hostname is auto-detected (no prompt)"
    - "add.secrets is configured to error on secrets"
  artifacts:
    - path: ".chezmoiroot"
      provides: "Source state directory pointer"
      contains: "home"
    - path: "home/.chezmoi.toml.tmpl"
      provides: "Init template with prompts and config"
      contains: "promptChoiceOnce"
    - path: "home/.chezmoidata.toml"
      provides: "Static shared configuration"
      contains: "[git]"
    - path: "home/.chezmoiignore"
      provides: "Conditional file exclusions"
      contains: ".chezmoi.os"
  key_links:
    - from: "home/.chezmoi.toml.tmpl"
      to: "~/.config/chezmoi/chezmoi.toml"
      via: "chezmoi init generates config from template"
    - from: "home/.chezmoiignore"
      to: ".chezmoi.toml.tmpl [data] section"
      via: "deviceType variable used in conditionals"
---

<objective>
Create the core chezmoi infrastructure with device identity prompting and conditional file management.

Purpose: Establish the foundation for the entire dotfiles system. This enables all subsequent phases to use device type and OS conditionals.

Output: Working chezmoi init experience that prompts for device type, derives email, auto-detects hostname, and configures secret prevention.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create directory structure with .chezmoiroot</name>
  <files>.chezmoiroot, home/</files>
  <action>
Create the source state directory structure using `.chezmoiroot`:

1. Create `.chezmoiroot` file in repository root containing single line: `home`
2. Create `home/` directory (the source state root)

This separates repository metadata (README, .planning/, etc.) from chezmoi's source state.

Reference: https://www.chezmoi.io/reference/special-files/chezmoiroot/
  </action>
  <verify>
- `.chezmoiroot` exists and contains `home`
- `home/` directory exists
  </verify>
  <done>Repository has `.chezmoiroot` pointing to `home/` subdirectory</done>
</task>

<task type="auto">
  <name>Task 2: Create chezmoi configuration files</name>
  <files>home/.chezmoi.toml.tmpl, home/.chezmoidata.toml, home/.chezmoiignore</files>
  <action>
Create three configuration files in `home/`:

**home/.chezmoi.toml.tmpl** (init template):
- Use `promptChoiceOnce` for device type selection with choices: "work", "personal"
- Validate selection is not empty, exit with error if empty
- Derive email from device type:
  - work -> user's work email (use placeholder, user will update)
  - personal -> user's personal email (use placeholder, user will update)
- Store hostname from `.chezmoi.hostname` (auto-detected)
- Add convenience boolean `isWork` for templates
- Configure `[add] secrets = "error"` to prevent accidental secret commits

Use the exact patterns from 01-RESEARCH.md:
- `{{- $deviceTypeChoices := list "work" "personal" -}}`
- `{{- $deviceType := promptChoiceOnce . "deviceType" "Device type" $deviceTypeChoices -}}`
- Validation with `writeToStdout` and `exit 1` if empty
- Email derivation with `if eq $deviceType "work"`

**home/.chezmoidata.toml** (static data):
- `[git]` section with `name = "Jack Hutson"` and `defaultBranch = "main"`
- `[editor]` section with `default = "nvim"`
- Note: Cannot use templates, static values only

**home/.chezmoiignore** (conditional exclusions):
- Always ignore: README.md, LICENSE, .git/, .planning/
- Use `{{ if ne .chezmoi.os "darwin" }}` to ignore macOS-only paths on Linux
- Use `{{ if ne .chezmoi.os "linux" }}` to ignore Linux-only paths on macOS
- Use `{{ if ne .deviceType "work" }}` to ignore work-only files on personal devices
- Use `{{ if ne .deviceType "personal" }}` to ignore personal-only files on work devices

Note: Use `ne` (not equal) since chezmoi includes everything by default and .chezmoiignore lists EXCLUSIONS.
  </action>
  <verify>
- `home/.chezmoi.toml.tmpl` contains `promptChoiceOnce` and `add.secrets = "error"`
- `home/.chezmoidata.toml` contains `[git]` section
- `home/.chezmoiignore` contains OS and device type conditionals with `ne`
  </verify>
  <done>All three chezmoi config files exist with correct content</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete chezmoi foundation: directory structure, init template with device type prompt, static data, and conditional ignoring</what-built>
  <how-to-verify>
1. Run `chezmoi init --source ~/.dotfiles` (or path to your repo)
2. Verify you see a "Device type" prompt with work/personal options
3. Select a device type
4. Check generated config: `cat ~/.config/chezmoi/chezmoi.toml`
   - Should show deviceType, email (derived), hostname (auto-detected)
   - Should have `[add] secrets = "error"`
5. Test re-init doesn't re-prompt: `chezmoi init --source ~/.dotfiles`
   - Should complete without prompting (values already exist)
6. (Optional) Test prompt force: `chezmoi init --prompt --source ~/.dotfiles`
   - Should re-prompt for device type

If the email placeholders need updating to your actual addresses, note that for me to fix.
  </how-to-verify>
  <resume-signal>Type "approved" if init works correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
- `chezmoi doctor` shows no errors related to config
- `chezmoi init` prompts for device type correctly
- Generated `~/.config/chezmoi/chezmoi.toml` contains all expected values
- `chezmoi ignored` shows expected files based on current OS and device type
</verification>

<success_criteria>
- Init prompts for device type with interactive menu (work/personal)
- Init fails gracefully if device type not selected
- Email is derived from device type (no separate prompt)
- Hostname is auto-detected (no prompt)
- `add.secrets = "error"` is configured
- Source state is in `home/` subdirectory
- Conditional ignoring works based on OS and device type
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
