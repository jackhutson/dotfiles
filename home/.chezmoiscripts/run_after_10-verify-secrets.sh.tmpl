#!/bin/bash
{{/* Verification script for 1Password integration */}}
{{/* Runs after chezmoi apply to ensure configuration is working */}}

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

# 1Password SSH agent socket path (macOS uses Group Containers path)
{{ if eq .chezmoi.os "darwin" -}}
OP_SSH_AGENT_SOCK="$HOME/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock"
{{ else -}}
OP_SSH_AGENT_SOCK="$HOME/.1password/agent.sock"
{{ end -}}

errors=0
warnings=0

echo "Verifying 1Password integration..."
echo ""

# Check 1: 1Password SSH agent socket exists
echo -n "  SSH agent socket... "
if [ -S "$OP_SSH_AGENT_SOCK" ]; then
    echo -e "${GREEN}OK${NC}"
else
    echo -e "${RED}FAILED${NC}"
    echo "    Socket not found at $OP_SSH_AGENT_SOCK"
    echo "    Enable SSH agent: 1Password > Settings > Developer > SSH Agent"
    ((errors++))
fi

# Check 2: SSH agent is responding and has keys
echo -n "  SSH agent keys... "
if SSH_AUTH_SOCK="$OP_SSH_AGENT_SOCK" ssh-add -l >/dev/null 2>&1; then
    key_count=$(SSH_AUTH_SOCK="$OP_SSH_AGENT_SOCK" ssh-add -l 2>/dev/null | wc -l | tr -d ' ')
    echo -e "${GREEN}OK${NC} ($key_count key(s))"
else
    echo -e "${RED}FAILED${NC}"
    echo "    No keys available from SSH agent"
    echo "    Unlock 1Password and ensure SSH keys have 'Use for SSH' enabled"
    ((errors++))
fi

# Check 3: GitHub SSH authentication works
echo -n "  GitHub SSH auth... "
github_result=$(ssh -o BatchMode=yes -o ConnectTimeout=5 -T git@github.com 2>&1)
if echo "$github_result" | grep -q "successfully authenticated"; then
    echo -e "${GREEN}OK${NC}"
elif echo "$github_result" | grep -q "Permission denied"; then
    echo -e "${RED}FAILED${NC}"
    echo "    GitHub SSH authentication failed"
    echo "    Add your public key to GitHub: https://github.com/settings/keys"
    ((errors++))
else
    echo -e "${YELLOW}UNKNOWN${NC}"
    echo "    Could not determine GitHub auth status"
    echo "    Response: $github_result"
    ((warnings++))
fi

# Check 4: Git signing format configured
echo -n "  Git signing format... "
gpg_format=$(git config --global gpg.format 2>/dev/null)
if [ "$gpg_format" = "ssh" ]; then
    echo -e "${GREEN}OK${NC}"
else
    echo -e "${RED}FAILED${NC}"
    echo "    gpg.format should be 'ssh', got '$gpg_format'"
    ((errors++))
fi

# Check 5: Git commit signing enabled
echo -n "  Git commit signing... "
gpg_sign=$(git config --global commit.gpgsign 2>/dev/null)
if [ "$gpg_sign" = "true" ]; then
    echo -e "${GREEN}OK${NC}"
else
    echo -e "${RED}FAILED${NC}"
    echo "    commit.gpgsign should be 'true', got '$gpg_sign'"
    ((errors++))
fi

# Check 6: op-ssh-sign binary exists
echo -n "  op-ssh-sign binary... "
{{ if eq .chezmoi.os "darwin" -}}
op_ssh_sign="/Applications/1Password.app/Contents/MacOS/op-ssh-sign"
{{ else -}}
op_ssh_sign="/opt/1Password/op-ssh-sign"
{{ end -}}
if [ -x "$op_ssh_sign" ]; then
    echo -e "${GREEN}OK${NC}"
else
    echo -e "${RED}FAILED${NC}"
    echo "    Binary not found or not executable at $op_ssh_sign"
    echo "    Install 1Password Desktop app"
    ((errors++))
fi

# Check 7: SSH_AUTH_SOCK environment variable
echo -n "  SSH_AUTH_SOCK env... "
if [ "$SSH_AUTH_SOCK" = "$OP_SSH_AGENT_SOCK" ]; then
    echo -e "${GREEN}OK${NC}"
else
    echo -e "${YELLOW}WARNING${NC}"
    echo "    SSH_AUTH_SOCK not set to 1Password agent"
    echo "    Current: ${SSH_AUTH_SOCK:-<not set>}"
    echo "    Expected: $OP_SSH_AGENT_SOCK"
    echo "    Restart terminal or run: source ~/.zshrc"
    ((warnings++))
fi

# Summary
echo ""
if [ $errors -eq 0 ] && [ $warnings -eq 0 ]; then
    echo -e "${GREEN}All 1Password integration checks passed!${NC}"
    exit 0
elif [ $errors -eq 0 ]; then
    echo -e "${YELLOW}$warnings warning(s), but no errors${NC}"
    exit 0
else
    echo -e "${RED}$errors error(s), $warnings warning(s)${NC}"
    echo "Please fix the issues above and run 'chezmoi apply' again"
    exit 1
fi
